<!-- app/templates/profile.html -->
{% extends "base.html" %}

{% block title %}Mi Perfil - Carflix{% endblock %}

{% block content %}
<div class="profile-page">
    <div class="profile-container">
        <h1><i class="fas fa-user-circle"></i> Mi Perfil</h1>

        <div class="profile-layout">
            <!-- Sidebar con foto de perfil -->
            <div class="profile-sidebar">
                <div class="profile-avatar">
                    <img src="{{ url_for('static', filename=current_user.profile_picture) }}" alt="{{ current_user.username }}">
                </div>
                <h2>{{ current_user.username }}</h2>
                <p class="profile-email">{{ current_user.email }}</p>
                {% if current_user.is_admin %}
                <span class="badge badge-admin">
                    <i class="fas fa-crown"></i> Administrador
                </span>
                {% endif %}
                <p class="profile-since">Miembro desde {{ current_user.created_at.strftime('%d/%m/%Y') }}</p>

                <div class="profile-stats">
                    <div class="stat">
                        <i class="fas fa-heart"></i>
                        <strong>{{ current_user.favorite_movies|length + current_user.favorite_series|length }}</strong>
                        <span>Favoritos</span>
                    </div>
                    <div class="stat">
                        <i class="fas fa-eye"></i>
                        <strong>{{ current_user.watched_movies|length + current_user.watched_episodes|length }}</strong>
                        <span>Vistos</span>
                    </div>
                </div>
            </div>

            <!-- Formulario de edición -->
            <div class="profile-main">
                <div class="profile-section">
                    <h3><i class="fas fa-edit"></i> Editar Perfil</h3>

                    <form method="POST" enctype="multipart/form-data" class="profile-form">
                        {{ form.hidden_tag() }}

                        <div class="form-group">
                            {{ form.username.label }}
                            {{ form.username(class="form-control") }}
                            {% if form.username.errors %}
                                <div class="form-errors">
                                    {% for error in form.username.errors %}
                                        <span class="error">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="form-group">
                            {{ form.email.label }}
                            {{ form.email(class="form-control") }}
                            {% if form.email.errors %}
                                <div class="form-errors">
                                    {% for error in form.email.errors %}
                                        <span class="error">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="form-group">
                            {{ form.profile_picture.label }}
                            {{ form.profile_picture(class="form-control-file") }}
                            <small class="form-text">Sube una imagen para tu foto de perfil</small>
                        </div>

                        <div class="form-actions">
                            {{ form.submit(class="btn btn-primary") }}
                        </div>
                    </form>
                </div>

                <div class="profile-section">
                    <h3><i class="fas fa-lock"></i> Seguridad</h3>
                    <p>Cambia tu contraseña para mantener tu cuenta segura.</p>
                    <a href="{{ url_for('change_password') }}" class="btn btn-secondary">
                        <i class="fas fa-key"></i> Cambiar Contraseña
                    </a>
                </div>

                <div class="profile-section danger-zone">
                    <h3><i class="fas fa-exclamation-triangle"></i> Zona Peligrosa</h3>
                    <p>Una vez eliminada tu cuenta, no hay vuelta atrás. Por favor, está seguro.</p>
                    <button onclick="confirmDelete()" class="btn btn-danger">
                        <i class="fas fa-trash"></i> Eliminar Cuenta
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function confirmDelete() {
    if (confirm('¿Estás COMPLETAMENTE SEGURO de que quieres eliminar tu cuenta?\n\nEsta acción NO se puede deshacer.\n\nSe perderán:\n- Tu lista de favoritos\n- Tu historial\n- Todos tus datos\n\n¿Continuar?')) {
        if (confirm('Última confirmación: ¿Eliminar cuenta permanentemente?')) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{{ url_for("delete_account") }}';

            const csrf = document.createElement('input');
            csrf.type = 'hidden';
            csrf.name = 'csrf_token';
            csrf.value = '{{ form.csrf_token._value() }}';

            form.appendChild(csrf);
            document.body.appendChild(form);
            form.submit();
        }
    }
}
</script>
{% endblock %}