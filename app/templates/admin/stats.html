{% extends "base.html" %}

{% block title %}Estad칤sticas Globales - Carflix Admin{% endblock %}

{% block content %}
<div class="admin-page">
    <div class="admin-container">
        <div class="admin-header">
            <div>
                <a href="{{ url_for('admin_dashboard') }}" class="back-link">
                    <i class="fas fa-arrow-left"></i> Volver al panel
                </a>
                <h1><i class="fas fa-chart-line"></i> Estad칤sticas Globales</h1>
            </div>
        </div>

        <!-- Resumen Global -->
        <div class="stats-summary">
            <div class="summary-card">
                <div class="summary-icon users">
                    <i class="fas fa-users"></i>
                </div>
                <div class="summary-info">
                    <h3>{{ global_stats.total_users }}</h3>
                    <p>Usuarios totales</p>
                </div>
            </div>

            <div class="summary-card">
                <div class="summary-icon time">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="summary-info">
                    <h3>{{ global_stats.total_hours }}h</h3>
                    <p>Tiempo total visto</p>
                </div>
            </div>

            <div class="summary-card">
                <div class="summary-icon movies">
                    <i class="fas fa-film"></i>
                </div>
                <div class="summary-info">
                    <h3>{{ global_stats.total_movies_watched }}</h3>
                    <p>Pel칤culas vistas</p>
                </div>
            </div>

            <div class="summary-card">
                <div class="summary-icon series">
                    <i class="fas fa-tv"></i>
                </div>
                <div class="summary-info">
                    <h3>{{ global_stats.total_episodes_watched }}</h3>
                    <p>Episodios vistos</p>
                </div>
            </div>
        </div>

        <!-- Comparaci칩n de Usuarios -->
        <div class="chart-section">
            <h2><i class="fas fa-users"></i> Comparaci칩n de Usuarios</h2>
            <div class="chart-container">
                <canvas id="usersComparisonChart"></canvas>
            </div>
        </div>

        <!-- Top Usuarios M치s Activos -->
        <div class="chart-section">
            <h2><i class="fas fa-trophy"></i> Usuarios M치s Activos</h2>
            <div class="table-container">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Posici칩n</th>
                            <th>Usuario</th>
                            <th>Pel칤culas Vistas</th>
                            <th>Episodios Vistos</th>
                            <th>Tiempo Total</th>
                            <th>Favoritos</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user_stat in user_stats %}
                        <tr>
                            <td>
                                <span class="rank-badge rank-{{ loop.index if loop.index <= 3 else 'other' }}">
                                    {% if loop.index == 1 %}游볞{% elif loop.index == 2 %}游볟{% elif loop.index == 3 %}游볠{% else %}{{ loop.index }}{% endif %}
                                </span>
                            </td>
                            <td>
                                <div class="user-cell">
                                    <i class="fas fa-user-circle"></i>
                                    <strong>{{ user_stat.username }}</strong>
                                </div>
                            </td>
                            <td>{{ user_stat.movies_watched }}</td>
                            <td>{{ user_stat.episodes_watched }}</td>
                            <td>{{ user_stat.total_hours }}h {{ user_stat.total_minutes }}m</td>
                            <td>{{ user_stat.favorites }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Contenido M치s Popular -->
        <div class="chart-section">
            <h2><i class="fas fa-fire"></i> Contenido M치s Popular</h2>

            <h3>Pel칤culas M치s Vistas</h3>
            <div class="popular-content-list">
                {% for movie in popular_movies %}
                <div class="popular-item">
                    <span class="popular-rank">{{ loop.index }}</span>
                    <img src="{{ url_for('static', filename=movie.poster_path) if movie.poster_path else 'https://via.placeholder.com/50x75?text=Poster' }}"
                         alt="{{ movie.title }}" class="popular-poster">
                    <div class="popular-info">
                        <h4>{{ movie.title }}</h4>
                        <p>{{ movie.watch_count }} visualizaciones</p>
                    </div>
                </div>
                {% endfor %}
            </div>

            <h3>Series M치s Vistas</h3>
            <div class="popular-content-list">
                {% for series in popular_series %}
                <div class="popular-item">
                    <span class="popular-rank">{{ loop.index }}</span>
                    <img src="{{ url_for('static', filename=series.poster_path) if series.poster_path else 'https://via.placeholder.com/50x75?text=Poster' }}"
                         alt="{{ series.title }}" class="popular-poster">
                    <div class="popular-info">
                        <h4>{{ series.title }}</h4>
                        <p>{{ series.watch_count }} episodios vistos</p>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
<script>
// Gr치fica de Comparaci칩n de Usuarios
const usersCtx = document.getElementById('usersComparisonChart');
if (usersCtx) {
    new Chart(usersCtx, {
        type: 'bar',
        data: {
            labels: [{% for user_stat in user_stats %}'{{ user_stat.username }}'{% if not loop.last %}, {% endif %}{% endfor %}],
            datasets: [{
                label: 'Pel칤culas',
                data: [{% for user_stat in user_stats %}{{ user_stat.movies_watched }}{% if not loop.last %}, {% endif %}{% endfor %}],
                backgroundColor: '#10b981'
            }, {
                label: 'Episodios',
                data: [{% for user_stat in user_stats %}{{ user_stat.episodes_watched }}{% if not loop.last %}, {% endif %}{% endfor %}],
                backgroundColor: '#8b5cf6'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: '#b3b3b3'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                },
                x: {
                    ticks: {
                        color: '#b3b3b3'
                    },
                    grid: {
                        display: false
                    }
                }
            },
            plugins: {
                legend: {
                    labels: {
                        color: '#b3b3b3'
                    }
                }
            }
        }
    });
}
</script>
{% endblock %}